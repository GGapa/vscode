# <center> 模拟赛 </center>

| 题目名称       | 弹性碰撞    | 轻涟           | 树上二维偏序问题 |
| -------------- | ----------- | -------------- | ---------------- |
| 题目类型       | 传统型      | 传统型         | 传统型           |
| 输入文件名     | physics.in  | vaguelette.in  | partial.in       |
| 输出文件名     | physics.out | vaguelette.out | partial.out      |
| 每个测试点时限 | 1.0s        | 3.0s           | 5.0s             |
| 内存限制       | 1024MB      | 1024MB         | 1024MB           |
| 子任务数目     | 8           | 15             | 6                |

- **注意事项**

1. 文件名（包括程序名和输入输出文件名）必须使用英文小写。
2. 若无特殊说明，输入文件中同一行内的多个整数、浮点数、字符串等均使用一个空格分隔。
3. 编译选项：`-O2 -std=c++14 -static`。
4. 开启子任务捆绑和子任务依赖。
5. 最终评测环境下，每道题目的时间限制至少应达到标准程序在所有数据中最高用时的 1.5 倍。


<div STYLE="page-break-after: always;"></div>

# 弹性碰撞 physics

**时间限制** / 1.0s

**空间限制** / 1024MB

### 题目描述

数轴上有 $n$ 个小球，相邻两个小球的间距相同。每个小球有两种属性：量子 (A) 和虚数 (B)，带有正电荷或者负电荷。一开始所有的小球都是量子 (A) 属性。

通过某种方式给所有的小球初速度，使得带正电荷的小球向左，反之则向右运动。我们认为所有小球的速度相同，且均沿直线运动。

当两个小球到达同一位置时，会发生弹性碰撞，沿着相反的方向按照原有速度继续运动。同时，这两个小球的电性会发生反转，属性也会发生反转。

例如：$\text{A}^-$ 和 $\text{B}^+$ 相撞后，$\text{A}^-$ 会变成 $\text{B}^+$，$\text{B}^+$ 会变成 $\text{A}^-$，并各自沿着相反的方向运动。

定义一种摆放方式的权值为，经过足够长的时间后，在左侧收集到的虚数 (B) 小球个数。

现在已经确定了一些小球的电性，剩下的小球可能带正电，也有可能带负电。请求出对于所有可能方案的权值之和。你需要将答案对 $998244353$ 取模。

### 输入格式

输入一行一个长为 $n$ 的字符串 $s$，代表从左到右小球的电性。具体而言：

- 若 $s_i$ 为 `+`，则第 $i$ 个小球带正电；
- 若 $s_i$ 为 `-`，则第 $i$ 个小球带负电；
- 若 $s_i$ 为 `?`，则第 $i$ 个小球可能带正电，也可能带负电。

### 输出格式

输出一行一个数表示答案。

### 样例输入输出

- **样例输入 1**

```
+?+-
```

- **样例输出 1**

```
1
```

- **样例输入 2**

```
??+-?-+
```

- **样例输出 2**

```
12
```

- **样例输入 3**

```
-????-?+?--????
```

- **样例输出 3**

```
3675
```

该题还附加了 8 个额外样例，分别对应每个子任务的限制情况。

### 数据范围

对于 100% 的数据，$1\le n\le 2\times 10^6$。

| 子任务编号 | 分值 |     $n\le$     |        特殊性质         |
| :--------: | :--: | :------------: | :---------------------: |
|     1      |  10  |      $10$      |           无            |
|     2      |  10  | $2\times 10^6$ |     $s$ 中没有 `?`      |
|     3      |  10  | $5\times 10^3$ | $s$ 中 `?` 不超过 15 个 |
|     4      |  10  |      $40$      |           无            |
|     5      |  10  |     $300$      |           无            |
|     6      |  20  | $5\times 10^3$ |           无            |
|     7      |  10  | $2\times 10^5$ |           无            |
|     8      |  20  | $2\times 10^6$ |           无            |

### 样例解释

在样例一中，如果初始局面是 `+++-`，最终将会收集到三个量子 (A) 小球，不会造成贡献；如果初始局面是 `+-+-`，则会收集到一个量子 (A) 和一个虚数 (B) 小球，造成 1 点贡献。所以总的答案是 1。

<div STYLE="page-break-after: always;"></div>

# 轻涟 vaguelette

**时间限制** / 3.0s

**空间限制** / 1024MB

### 题目描述

小 H 在学习轻涟剖分。

对于一棵 $n$ 个结点，边有边权的树 $T$ 和长度为 $m$（$m$ 为偶数），值域在 $[1,n]$ 内的序列 $a$，定义它的贡献 $F(T,a)$ 表示将 $a$ 中元素两两配对后在树上形成的 $\dfrac{m}{2}$ 条路径的长度和的最小值。注意如果有重复元素需要配对多次。

同时，定义它的气氛值 $G(T,a)$ 表示对于 $a$ 的每个长为偶数的子序列 $a'$，$F(T,a')$ 的和。

再定义轻涟值 $H(T,m)$ 表示对于任意合法的，长度为 $m$ 的序列 $p$，$G(T,p)$ 的和。

小 H 使用轻涟剖分轻松的解决了这个问题，于是小 Y 决定加强一下。

**问题一：给定 $n$ 个结点的树 $T$ 和偶数 $m$，请对其中的所有连通块 $T'$，求 $H(T',m)$ 的和。**

小 H 再次使用轻涟剖分轻松的解决了这个问题。但这次跟上次不同的是，小 Y 抽干了小 H 的龙脉，小 H 失忆了。

在失忆之后，小 H 想要回忆起问题的答案，却发现自己只记得前 $k$ 个点跟它父亲之间的边权，却忘记了所有点的父亲。不过他还知道一件事情，那就是 **每个非根结点的父亲编号都小于它自身的编号**。

**问题二：小 H 想知道，在仅保留前 $k$ 个点的情况下，所有合法的树中，问题一的答案之和。**

答案对 $10^9+7$ 取模。

### 输入格式

第一行，输入 $n,m,k$。

接下来一行，输入 $n-1$ 个数，表示 $fa_{2\cdots n}$。

接下来一行，输入 $n-1$ 个数，表示 $val_{2\cdots n}$，也就是每个点与它的父亲之间的边权。

### 输出格式

输出一行两个数分别表示两问的答案。

**第一问正确会获得 60% 的分数，第二问正确会获得 40% 的分数。如果你不会某一问，请随便输出一个数以保证格式正确。每个子任务的评分取该子任务中每个测试点的得分最小值**。

### 样例输入输出

- **样例输入 1**

```
4 4 4
1 2 3
1 2 1
```

- **样例输出 1**

```
4944 28976
```

- **样例输入 2**

```
7 7 7
1 1 2 2 3 3
5 4 3 2 1 2
```

- **样例输出 2**

```
42528697 1655828
```

该题还附加了 15 个额外样例，分别对应每个子任务的限制情况。

### 数据范围

对于 100% 的数据，$1\le n\le 7.5\times 10^3$，$2\le m\le 10^9$，$1\le k\le 500$，$1\le fa_i<i$，$1\le val_i\le 10^9$。

保证除前两个样例外，均有 $1\le k\le \lceil \dfrac{n}{15}\rceil$。

| 子任务编号 | 分值 |      $n\le$       | $m\le$ |  特殊性质  |
| :--------: | :--: | :---------------: | :----: | :--------: |
|     1      |  10  |        $4$        |  $2$   |     无     |
|     2      |  5   |       $20$        |  $20$  |     无     |
|     3      |  5   |       $50$        |  $50$  |     无     |
|     4      |  5   |       $100$       | $100$  |     无     |
|     5      |  5   |       $200$       | $200$  |     无     |
|     6      |  5   |       $300$       | $300$  |     无     |
|     7      |  5   |  $5\times 10^3$   | $10^9$ | $fa_i=i-1$ |
|     8      |  10  |  $5\times 10^3$   | $10^9$ | $val_i=1$  |
|     9      |  5   |  $5\times 10^3$   |  $2$   |     无     |
|     10     |  5   | $1.25\times 10^3$ | $10^9$ |     无     |
|     11     |  10  | $2.5\times 10^3$  | $10^9$ |     无     |
|     12     |  5   | $3.75\times 10^3$ | $10^9$ |     无     |
|     13     |  10  |  $5\times 10^3$   | $10^9$ |     无     |
|     14     |  5   | $6.25\times 10^3$ | $10^9$ |     无     |
|     15     |  10  | $7.5\times 10^3$  | $10^9$ |     无     |

### 样例解释

在样例一的问题一中，连通块 `1-2`，`2-3`，`3-4` 造成的贡献分别为 56，112，56；连通块 `1-2-3`，`2-3-4` 造成的贡献均为 768；连通块 `1-2-3-4` 造成的贡献为 3184。

在样例一的问题二中，可以列出如下表格：

| 父亲数组 | $fa_3=1$ | $fa_3=2$ |
| :------: | :------: | :------: |
| $fa_4=1$ |   5056   |   4488   |
| $fa_4=2$ |   4488   |   5056   |
| $fa_4=3$ |   4944   |   4944   |

<div STYLE="page-break-after: always;"></div>

# 树上二维偏序问题 partial

**时间限制** / 5.0s

**空间限制** / 1024MB

### 题目描述

给定一棵 $n$ 个结点的有根树，根结点是 1 号。每个点有一个权值 $a_i\in\{0,1,?\}$，问号可以替换成 0 和 1 中的任意一个值。还有 $q$ 次修改操作，每次修改会使得某个点的 $a$ 发生改变。

如果两个点 $i,j$ 满足 $i$ 是 $j$ 的祖先且 $a_i<a_j$，会造成一点贡献。小 H 想知道确定所有问号的取值后，最大的贡献和是多少。在每次修改操作结束后，你都需要回答这个问题。

### 输入格式

第一行输入 $n,q$。

第二行输入长度为 $n$ 的字符串 $s$，$s_i$ 表示 $a_i$ 的取值。保证 $s_i\in\{0,1,?\}$。

第三行输入 $n-1$ 个数 $fa_{2\cdots n}$ 表示每个点的父亲。

接下来 $q$ 行，每行输入一个正整数 $u$ 和字符 $c$，表示将 $a_u$ 改成 $c$，保证 $c\in\{0,1,?\}$。

### 输出格式

共 $q$ 行，表示每次修改后的最大的贡献和。

### 样例输出输出

- **样例输入 1**

```
5 9
0?1?1
1 2 3 3 
5 0
1 0
2 0
2 ?
1 1
4 0
1 1
5 0
4 ?
```

- **样例输出 1**

```
4
4
4
4
2
1
1
1
2
```

- **样例输入 2**

```
10 9
0001?0?101
1 2 3 4 1 1 4 5 6 
2 ?
8 ?
9 0
4 0
3 ?
10 ?
1 ?
2 1
2 1
```

- **样例输出 2**

```
12
12
12
11
11
11
11
10
10
```

该题还附加了 6 个额外样例，分别对应每个子任务的限制情况。

### 数据范围

对于 100% 的数据，$1\le n\le 2\times 10^5$，$1\le q\le 2\times 10^5$，$1\le fa_i<i$。

| 子任务编号 | 分值 |     $n\le$     |     $q\le$     |     特殊性质     |
| :--------: | :--: | :------------: | :------------: | :--------------: |
|     1      |  10  |      $10$      |      $10$      |        无        |
|     2      |  10  | $2\times 10^5$ | $2\times 10^5$ |     $fa_i=1$     |
|     3      |  15  | $2\times 10^5$ | $2\times 10^5$ | 任何时刻没有问号 |
|     4      |  15  |     $10^3$     |     $10^3$     |        无        |
|     5      |  25  | $2\times 10^5$ | $2\times 10^5$ |    $fa_i=i-1$    |
|     6      |  25  | $2\times 10^5$ | $2\times 10^5$ |        无        |
